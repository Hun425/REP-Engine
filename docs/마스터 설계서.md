# 프로젝트: 실시간 유저 행동 기반 개인화 추천 및 알림 엔진 (REP-Engine)

본 문서는 Kafka와 Elasticsearch를 활용한 실시간 이벤트 기반 아키텍처(EDA) 설계 및 구현 가이드라인을 담고 있습니다.

## 1. 시스템 개요 (System Overview)

- **목표:** 유저의 실시간 활동(클릭, 검색)을 수집하여 1초 이내에 개인화 추천을 제공하고, 특정 비즈니스 조건(가격 변동 등) 발생 시 즉각적인 알림을 발송함.

- **핵심 가치:**

    - **Low Latency:** 유저 행동이 추천 결과에 즉시 반영되어야 함 (Java 25 가상 스레드 및 Generational ZGC 활용).

    - **Scalability:** 초당 수만 건의 이벤트를 처리할 수 있는 구조.

    - **Reliability:** 분산 환경에서 데이터 유실 및 중복 처리 방지 (Exactly-once semantics 지향).


## 2. 기술 스택 (Tech Stack)

| 분류 | 기술 | 버전 | 선택 이유 |
|-----|-----|------|----------|
| Language | Kotlin | 2.x | 코루틴 기반 비동기 처리, 간결한 문법 |
| Runtime | JVM | 25 | Virtual Threads, Generational ZGC |
| Framework | Spring Boot | 3.4+ | Virtual Threads 네이티브 지원 |
| Messaging | Apache Kafka | 3.6+ | 고처리량 이벤트 스트리밍 |
| Schema | Confluent Schema Registry | 7.5+ | Avro 기반 스키마 관리 |
| Search | Elasticsearch | 8.11+ | 벡터 검색(KNN) 지원 |
| Cache | Redis | 7.2+ | 유저 취향 벡터 실시간 캐싱 |
| Embedding | Sentence-Transformers | - | multilingual-e5-base 모델 |
| Infra | Docker Compose | - | 로컬 개발 환경 |
| Test | Testcontainers | - | 통합 테스트 |


## 3. 시스템 아키텍처 (Architecture)

### 3.1 전체 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              REP-Engine Architecture                             │
└─────────────────────────────────────────────────────────────────────────────────┘

                                   ┌─────────────────┐
                                   │  Traffic        │
                                   │  Simulator      │
                                   │  (Virtual       │
                                   │   Threads)      │
                                   └────────┬────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 Apache Kafka                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ user.action.v1   │  │product.inventory │  │notification.push │              │
│  │   (12 파티션)    │  │     (3 파티션)   │  │    (6 파티션)    │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────▲─────────┘              │
└───────────┼─────────────────────┼─────────────────────┼─────────────────────────┘
            │                     │                     │
            ▼                     ▼                     │
┌───────────────────────┐  ┌──────────────────┐        │
│  Behavior Consumer    │  │ Inventory        │        │
│  ┌─────────────────┐  │  │ Consumer         │        │
│  │ ES Bulk Index   │  │  │ ┌──────────────┐ │        │
│  │ (user_behavior) │  │  │ │Price Change  │ │        │
│  └────────┬────────┘  │  │ │Detection     │─┼────────┘
│           │           │  │ └──────────────┘ │
│  ┌────────▼────────┐  │  └──────────────────┘
│  │ Preference      │  │
│  │ Vector Update   │  │         ┌──────────────────┐
│  └────────┬────────┘  │         │ Notification     │
└───────────┼───────────┘         │ Worker           │
            │                     │ ┌──────────────┐ │
            ▼                     │ │ Push/SMS     │ │
┌───────────────────────┐         │ │ Simulation   │ │
│        Redis          │         │ └──────────────┘ │
│  (User Preference     │         └──────────────────┘
│   Vector Cache)       │
└───────────┬───────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Elasticsearch                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │  product_index   │  │user_behavior     │  │user_preference   │              │
│  │  (KNN enabled)   │  │     _index       │  │     _index       │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌───────────────────────┐
│   Recommendation API  │
│   (KNN Vector Search) │
└───────────────────────┘
```

### 3.2 컴포넌트 상세 설명

| 컴포넌트 | 역할 | 기술 |
|---------|------|------|
| **Traffic Simulator** | 수만 명의 가상 유저 행동을 생성하여 Kafka로 전송. 개발/테스트용 데이터 소스 | Virtual Threads, Coroutines |
| **Behavior Consumer** | 유저 행동 이벤트를 소비하여 ES 인덱싱 및 취향 벡터 갱신 | Kafka Consumer, ES Bulk API |
| **Inventory Consumer** | 상품 재고/가격 변동 감지 후 알림 대상 유저 추출 | Kafka Consumer |
| **Notification Worker** | 알림 메시지를 소비하여 발송 (시뮬레이션) | Kafka Consumer |
| **Recommendation API** | 유저 취향 벡터 기반 KNN 검색으로 상품 추천 | REST API, ES KNN |
| **Embedding Service** | 상품/유저 텍스트를 벡터로 변환 | Python FastAPI, multilingual-e5-base |

> **Note:** Traffic Simulator는 개발/테스트 환경용입니다. 프로덕션에서는 실제 클라이언트(웹/앱)가 이벤트를 전송합니다.

### 3.2.1 서비스 포트

| 서비스 | 로컬 포트 | Docker 포트 | 용도 |
|-------|----------|-------------|------|
| Simulator | 8084 | 8084 | Actuator, REST API (시뮬레이션 제어) |
| Behavior Consumer | 8085 | 8085 | Actuator (메트릭 수집) |
| Recommendation API | 8080 | 8082 | REST API (추천 서비스) |
| Notification Service | 8083 | 8083 | Actuator (메트릭 수집) |
| Frontend | 3001 (Vite) | 3001 | React 대시보드 |
| Embedding Service | 8000 | 8000 | REST API (벡터 변환) |

### 3.3 프로젝트 모듈 구조

```
REP-Engine/
├── common-avro/           # Avro 스키마 및 생성 클래스
├── common-model/          # 공유 데이터 모델 (ProductDocument, UserPreferenceData 등)
├── simulator/             # 트래픽 시뮬레이터 (Phase 1)
├── behavior-consumer/     # 유저 행동 Consumer (Phase 2)
├── recommendation-api/    # 추천 API 서버 (Phase 3)
├── notification-service/  # 알림 서비스 (Phase 4)
├── frontend/              # React 통합 대시보드 (Phase 6)
├── docker/                # Docker Compose, 초기화 스크립트
└── docs/                  # 설계 문서, ADR
```

| 모듈 | 설명 | 의존성 |
|-----|------|--------|
| **common-avro** | Kafka Avro 스키마 정의 및 자동 생성 클래스 | - |
| **common-model** | 모듈 간 공유 데이터 클래스 (ES Document, Redis Data) | - |
| **simulator** | 가상 유저 행동 생성 및 Kafka 발행 | common-avro |
| **behavior-consumer** | Kafka 소비, ES 인덱싱, 취향 벡터 갱신 | common-avro, common-model |
| **recommendation-api** | KNN 검색 기반 추천 REST API | common-model |
| **notification-service** | 재고/가격 변동 감지, 알림 발송 | common-avro, common-model |
| **frontend** | React 통합 대시보드 (추천 검색, 모니터링, 시뮬레이터 제어) | - |


## 4. 상세 데이터 모델 (Data Model)

### 4.1 Kafka Topics

| 토픽명 | 설명 | 파티션 | 키(Key) | 스키마 |
|-------|------|--------|---------|--------|
| user.action.v1 | 유저 클릭, 검색, 노출 로그 | 12 | userId | Avro |
| user.action.v1.dlq | 처리 실패 메시지 격리 | 3 | userId | Avro |
| product.inventory.v1 | 재고 변경, 가격 변동 | 3 | productId | Avro |
| notification.push.v1 | 발송 예정 알림 | 6 | userId | Avro |

#### 파티션 수 결정 근거

| 토픽 | 파티션 | 근거 |
|-----|--------|------|
| user.action.v1 | **12** | 목표 TPS 10,000 / 파티션당 처리량 ~1,000 = 10. 여유분 포함 12개. Consumer 인스턴스 최대 12개까지 수평 확장 가능 |
| product.inventory.v1 | **3** | 상품 변동은 유저 행동 대비 1/10 수준. TPS ~1,000 예상 |
| notification.push.v1 | **6** | 알림 발송은 외부 API 호출로 병목. Worker 6개로 병렬 처리 |

### 4.2 Elasticsearch Indices

| 인덱스명 | 용도 | 샤드 | 벡터 인덱싱 |
|---------|------|------|------------|
| product_index | 상품 정보 + 임베딩 벡터 | 1 | O (KNN) |
| user_behavior_index | 유저 행동 로그 (시계열) | 3 | X |
| user_preference_index | 유저 취향 벡터 백업 | 1 | X |
| notification_history_index | 알림 발송 이력 | 2 | X |

### 4.3 Redis 스키마

```
Key Pattern: user:preference:{userId}
Value: {"preferenceVector": [...], "actionCount": int, "updatedAt": timestamp}
TTL: 24시간
```


## 5. 실무급 구현 핵심 포인트 (Key Engineering Points)

### 5.1 데이터 정합성 및 안정성

- **Idempotency:** `traceId`를 ES Document ID로 사용하여 중복 처리 방지 (Upsert).

- **Dead Letter Queue (DLQ):** 처리 실패한 메시지를 `*.dlq` 토픽으로 격리, 수동 재처리.

- **Graceful Shutdown:** Java 25의 Structured Concurrency를 활용한 안전한 종료.

- **Schema Evolution:** Avro + Schema Registry로 하위 호환성 보장 (BACKWARD_TRANSITIVE).

### 5.2 성능 최적화

- **Virtual Threads:** I/O 집약적인 Kafka Consumer와 ES Indexing을 경량 스레드로 처리.

- **Generational ZGC:** 대규모 힙 메모리에서도 1ms 미만의 GC 휴지 시간 유지.

- **Bulk Indexing:** ES 인덱싱 시 500건 또는 1초 단위로 배치 처리.

- **Redis 캐싱:** 유저 취향 벡터를 Redis에 캐싱하여 ES 조회 부하 분산.

### 5.3 임베딩 전략

- **모델:** intfloat/multilingual-e5-base (768 차원)
- **상품 임베딩:** 상품명 + 카테고리 + 설명 조합
- **유저 취향:** 최근 행동 상품 벡터의 지수 이동 평균(EMA)


## 6. 단계별 구축 로드맵 (Roadmap)

| Phase | 이름 | 주요 산출물 |
|-------|------|------------|
| **1** | 인프라 및 시뮬레이터 | Docker Compose, Kafka 토픽, 트래픽 시뮬레이터 |
| **2** | 데이터 파이프라인 | Kafka Consumer, ES Bulk Indexing, DLQ 처리 |
| **3** | 실시간 추천 엔진 | 임베딩 서비스, KNN 검색 API, 취향 벡터 관리 |
| **4** | 실시간 알림 시스템 | 가격 변동 감지, 알림 발송 시뮬레이션 |
| **5** | 운영 모니터링 | Prometheus + Grafana, 로깅, 알림 |
| **6** | 프론트엔드 대시보드 | React 통합 UI, 추천 검색, 시뮬레이터 제어 |


## 7. 테스트 전략

| 레벨 | 도구 | 범위 |
|-----|------|------|
| Unit | JUnit 5, MockK | 비즈니스 로직 |
| Integration | Testcontainers | Kafka, ES, Redis 연동 |
| E2E | Docker Compose | 전체 파이프라인 |
| Performance | k6, Gatling | 부하 테스트 |


## 8. 관련 문서

| 문서 | 설명 |
|-----|------|
| [Infrastructure](./infrastructure.md) | Docker Compose, 환경 설정 |
| [ADR-001: 동시성 전략](./adr-001-concurrency-strategy.md) | Coroutines + Virtual Threads |
| [ADR-002: Schema Registry](./adr-002-schema-registry.md) | Avro 직렬화 |
| [ADR-003: Embedding 모델](./adr-003-embedding-model.md) | multilingual-e5-base |
| [ADR-004: 벡터 저장소](./adr-004-vector-storage.md) | ES + Redis Hybrid |
| [Phase 1: 시뮬레이터](./phase%201.md) | 트래픽 생성기 구현 |
| [Phase 2: 데이터 파이프라인](./phase%202.md) | Consumer, ES 인덱싱 |
| [Phase 3: 추천 엔진](./phase%203.md) | KNN 검색, 추천 API |
| [Phase 4: 알림 시스템](./phase%204.md) | 실시간 알림 |
| [Phase 5: 모니터링](./phase%205.md) | 관측성, 테스트 |
| [Phase 6: 프론트엔드](./phase%206.md) | React 대시보드 |