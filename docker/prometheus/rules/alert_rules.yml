groups:
  - name: rep-engine-alerts
    rules:
      # ============================================
      # Application Health
      # ============================================
      - alert: ApplicationDown
        expr: up{job="rep-engine"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.instance }} 애플리케이션이 다운되었습니다"
          description: "{{ $labels.instance }}가 1분 이상 응답하지 않습니다."

      # ============================================
      # Kafka Consumer
      # ============================================
      - alert: HighKafkaConsumerLag
        expr: sum(kafka_consumergroup_lag{consumergroup="behavior-consumer-group"}) > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka Consumer Lag이 높습니다"
          description: "behavior-consumer-group의 lag이 {{ $value }}입니다. 처리 지연이 발생할 수 있습니다."

      - alert: KafkaDLQMessagesDetected
        expr: increase(kafka_dlq_sent_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "DLQ에 메시지가 적재되고 있습니다"
          description: "지난 5분간 {{ $value }}개의 메시지가 DLQ로 전송되었습니다."

      # ============================================
      # Recommendation API
      # ============================================
      - alert: HighRecommendationLatency
        expr: histogram_quantile(0.99, sum(rate(recommendation_latency_seconds_bucket[5m])) by (le)) > 0.1
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "추천 API P99 레이턴시가 100ms를 초과합니다"
          description: "현재 P99: {{ $value | humanizeDuration }}"

      - alert: HighKnnFailureRate
        expr: rate(recommendation_knn_failed_total[5m]) > 1
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "KNN 검색 실패율이 높습니다"
          description: "분당 {{ $value }} 건의 KNN 검색이 실패하고 있습니다."

      # ============================================
      # Elasticsearch
      # ============================================
      - alert: ElasticsearchClusterRed
        expr: elasticsearch_cluster_health_status{color="red"} == 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Elasticsearch 클러스터가 RED 상태입니다"
          description: "즉시 확인이 필요합니다."

      - alert: HighESBulkFailureRate
        expr: rate(es_bulk_batch_failed_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ES Bulk 인덱싱 실패가 발생하고 있습니다"
          description: "분당 {{ $value }} 건의 배치가 실패하고 있습니다."

      # ============================================
      # Redis
      # ============================================
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis 메모리 사용률이 80%를 초과합니다"
          description: "현재 사용률: {{ $value | humanizePercentage }}"

      # ============================================
      # JVM
      # ============================================
      - alert: HighJVMHeapUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "JVM Heap 사용률이 85%를 초과합니다"
          description: "{{ $labels.instance }}의 힙 사용률: {{ $value | humanizePercentage }}"
